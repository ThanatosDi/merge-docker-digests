name: Merge Multi-Arch Manifest

on:
  workflow_call:
    inputs:
      image-name:
        description: 'Full image name (e.g., ghcr.io/user/repo or user/repo for Docker Hub)'
        required: true
        type: string
      artifact-pattern:
        description: 'Pattern to match digest artifacts (e.g., digest-8.4-*)'
        required: true
        type: string
      tags:
        description: 'Tags to apply, separated by newlines'
        required: true
        type: string
      timezone:
        description: 'Timezone for date tag'
        required: false
        type: string
        default: 'UTC'
      registry:
        description: 'Container registry (e.g., ghcr.io, docker.io). Leave empty for Docker Hub'
        required: false
        type: string
        default: ''
    secrets:
      registry-username:
        description: 'Registry username (defaults to github.actor for GHCR)'
        required: false
      registry-password:
        description: 'Registry password/token (defaults to github.token for GHCR)'
        required: false

jobs:
  merge:
    name: Merge Manifest
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Download Digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: ${{ inputs.artifact-pattern }}
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry || '' }}
          username: ${{ secrets.registry-username || github.actor }}
          password: ${{ secrets.registry-password || github.token }}

      - name: Create and Push Manifest
        working-directory: /tmp/digests
        run: |
          # 將 tags 轉換成 -t 參數
          TAGS=""
          while IFS= read -r tag; do
            [ -n "$tag" ] && TAGS="$TAGS -t ${{ inputs.image-name }}:$tag"
          done <<< "${{ inputs.tags }}"

          # 合併所有 digest 並推送
          docker buildx imagetools create $TAGS \
            $(printf '${{ inputs.image-name }}@sha256:%s ' *)

      - name: Inspect Image
        run: |
          # 取第一個 tag 來檢查
          FIRST_TAG=$(echo "${{ inputs.tags }}" | head -n1)
          docker buildx imagetools inspect ${{ inputs.image-name }}:$FIRST_TAG
